name: Release

on:
  push:
    tags: ['v*.*.*']

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  check:
    name: Run Checks
    uses: ./.github/workflows/ci.yml

  pack-build-native:
    name: Build Native
    needs: check
    strategy:
      matrix:
        include:
          # Linux x64
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-24.04
          
          # Linux ARM64
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-24.04-arm

          # Windows x64
          - target: x86_64-pc-windows-msvc
            os: windows-2025
          
          # macOS ARM64
          - target: aarch64-apple-darwin
            os: macos-26
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7
        with:
          targets: ${{ matrix.target }}
          
      - name: Restore Rust Cargo Cache
        id: cache-rust-cargo
        uses: actions/cache/restore@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            native/target/
          key: ${{ matrix.os }}-cargo-${{ hashFiles('native/Cargo.*') }}
          restore-keys: |
            ${{ matrix.os }}-cargo-
        continue-on-error: true
          
      - name: Setup Protoc
        uses: arduino/setup-protoc@v3

      - name: Build Native Library
        working-directory: native
        run: cargo build --target ${{ matrix.target }} --profile release

      - name: (Linux) Prepare Native Library Artifacts
        if: runner.os == 'Linux'
        run: |
          mkdir -p artifacts/native/target/${{ matrix.target }}/release/
          cp native/target/${{ matrix.target }}/release/*.so artifacts/native/target/${{ matrix.target }}/release/

      - name: (Windows) Prepare Native Library Artifacts
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path artifacts/native/target/${{ matrix.target }}/release/
          Copy-Item native/target/${{ matrix.target }}/release/*.dll artifacts/native/target/${{ matrix.target }}/release/
          
      - name: (MacOS) Prepare Native Library Artifacts
        if: runner.os == 'MacOS'
        run: |
          mkdir -p artifacts/native/target/${{ matrix.target }}/release/
          cp native/target/${{ matrix.target }}/release/*.dylib artifacts/native/target/${{ matrix.target }}/release/

      - name: Upload Native Library as Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: native-${{ matrix.target }}
          path: artifacts/**
          overwrite: true
          retention-days: 1

      - name: Save Rust Cargo Cache
        uses: actions/cache/save@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            native/target/
          key: ${{ steps.cache-rust-cargo.outputs.cache-primary-key }}
        continue-on-error: true
  
  pack:
    name: Pack NuGet
    needs: pack-build-native
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "10.0.x"

      - name: Download Artifacts
        uses: actions/download-artifact@v7
        with:
          path: ./
          merge-multiple: true

      - name: Print Repository Structure
        run: ls -lR
        
      - name: Pack NuGet Package
        run: dotnet pack src/DataFusionSharp/DataFusionSharp.csproj -c Release -p:BuildNativeLib=false -o ./packages

      - name: Upload NuGet Package
        uses: actions/upload-artifact@v6
        with:
          name: nuget-package
          path: packages/*
          retention-days: 1

  pack-smoke-test:
    name: Pack Test
    needs: pack
    strategy:
      matrix:
        os: [ubuntu-24.04, ubuntu-24.04-arm, windows-2025, macos-26]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "10.0.x"

      - name: Download NuGet Package Artifacts
        uses: actions/download-artifact@v7
        with:
          name: nuget-package
          path: packages

      - name: Build Test Application with Local NuGet Package
        working-directory: tests/DataFusionSharp.PackageSmokeTest
        run: dotnet build -c Release -p:UseLocalPackage=true
      
      - name: Run Test Application
        working-directory: tests/DataFusionSharp.PackageSmokeTest
        run: dotnet run --no-build -c Release -p:UseLocalPackage=true
        timeout-minutes: 1

  pack-publish-github:
    name: Publish to GitHub Packages
    needs: pack-smoke-test
    runs-on: ubuntu-24.04
    permissions:
      packages: write
    steps:
      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "10.0.x"

      - name: Download NuGet Package Artifacts
        uses: actions/download-artifact@v7
        with:
          name: nuget-package
          path: packages

      - name: Extract Version
        id: version
        shell: bash
        run: |
          # Find the package files
          NUPKG=$(ls packages/DataFusionSharp.*.nupkg | head -n 1)
          SNUPKG=$(ls packages/DataFusionSharp.*.snupkg | head -n 1)

          if [ -z "$NUPKG" ]; then
            echo "âŒ No nupkg found"
            exit 1
          fi

          if [ -z "$SNUPKG" ]; then
            echo "âŒ No snupkg found"
            exit 1
          fi

          # Extract version from filename
          # DataFusionSharp.0.1.0.nupkg -> 0.1.0
          VERSION=$(basename "$NUPKG" | sed -E 's/DataFusionSharp\.(.*)\.nupkg/\1/')

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "nupkg=$NUPKG" >> $GITHUB_OUTPUT
          echo "snupkg=$SNUPKG" >> $GITHUB_OUTPUT

          echo "ðŸ“¦ Package: $NUPKG"
          echo "ðŸ“¦ Symbol Package: $SNUPKG"
          echo "ðŸ“Œ Version: $VERSION"

      - name: Publish to GitHub Packages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          dotnet nuget push \
            ${{ steps.version.outputs.nupkg }} \
            --api-key "$GITHUB_TOKEN" \
            --source https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json

      - name: Publish Symbols to GitHub Packages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          dotnet nuget push \
            ${{ steps.version.outputs.snupkg }} \
            --api-key "$GITHUB_TOKEN" \
            --source https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json
